(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(n){if(n.ep)return;n.ep=!0;const a=e(n);fetch(n.href,a)}})();const F=[{name:"rabbit",food:"carrot"},{name:"monkey",food:"banana"},{name:"elephant",food:"peanut"},{name:"cat",food:"fish"},{name:"dog",food:"fish"},{name:"goldfish",food:"plankton"},{name:"bear",food:"honey"},{name:"turtle",food:"leafy"},{name:"jellyfish",food:"plankton"},{name:"whale",food:"krill"}],T={CELL_SIZE:40},C={EASY:{id:"easy",label:"Easy",description:"Small maze - Quick adventure",width:15,height:15,color:"#2ECC71",emoji:"üå±"},MEDIUM:{id:"medium",label:"Medium",description:"Medium maze - Challenge yourself",width:21,height:21,color:"#F39C12",emoji:"üåø"},HARD:{id:"hard",label:"Hard",description:"Large maze - Expert challenge",width:27,height:27,color:"#E74C3C",emoji:"üå≥"}},w={SELECTION:"selection",DIFFICULTY:"difficulty",PLAYING:"playing",COMPLETED:"completed"},I={WALL:"wall",PATH:"path"},P={ENABLED:!0,DEFAULT_VOLUME:.3,BACKGROUND_MUSIC_PATH:"/assets/audio/background-music.wav",AUTO_PLAY_ATTEMPTS:3,AUTO_PLAY_DELAY_MS:500};class Y{constructor(){this.reset()}reset(){this.currentState=w.SELECTION,this.selectedAnimal=null,this.selectedDifficulty=null,this.maze=null,this.playerPosition=null,this.sessionStartTime=null,this.sessionEndTime=null}_isValidAnimal(t){return!t||typeof t!="string"?!1:F.some(e=>e.name.toLowerCase()===t.toLowerCase())}selectAnimal(t){this._isValidAnimal(t)&&(this.selectedAnimal=t.toLowerCase())}getSelectedAnimal(){return this.selectedAnimal}selectDifficulty(t){this.selectedDifficulty=t}getSelectedDifficulty(){return this.selectedDifficulty}setMaze(t){this.maze=t}getMaze(){return this.maze}setPlayerPosition(t){this.playerPosition=t}getPlayerPosition(){return this.playerPosition}setState(t){this.currentState=t}getState(){return this.currentState}isAtGoal(){return!this.playerPosition||!this.maze||!this.maze.goal?!1:this.playerPosition.x===this.maze.goal.x&&this.playerPosition.y===this.maze.goal.y}startSession(){this.sessionStartTime=Date.now()}endSession(){this.sessionEndTime=Date.now()}getSessionDuration(){return!this.sessionStartTime||!this.sessionEndTime?0:(this.sessionEndTime-this.sessionStartTime)/1e3}getSnapshot(){return{gameState:this.currentState,currentState:this.currentState,selectedAnimal:this.selectedAnimal,maze:this.maze,playerPosition:this.playerPosition,sessionStartTime:this.sessionStartTime,sessionEndTime:this.sessionEndTime}}}const u=new Y;class B{constructor(){this.animals=F}getAllAnimals(){return this.animals}getAnimalByName(t){return!t||typeof t!="string"?null:this.animals.find(e=>e.name.toLowerCase()===t.toLowerCase())||null}getFoodForAnimal(t){const e=this.getAnimalByName(t);return e?e.food:null}getAnimalIconPath(t){return`/src/assets/icons/${t}.svg`}getFoodIconPath(t){return`/src/assets/icons/foods/${t}.svg`}isValidAnimal(t){return!t||typeof t!="string"?!1:this.getAnimalByName(t)!==null}}const E=new B;class k{constructor(){this.width=15,this.height=15}generate(t=15,e=15){this.width=t,this.height=e;const i=this.initializeGrid();this.carvePassages(i,1,1);const n={x:1,y:1},a={x:t-2,y:e-2};return{grid:i,start:n,goal:a,width:t,height:e}}initializeGrid(){const t=[];for(let e=0;e<this.height;e++){t[e]=[];for(let i=0;i<this.width;i++)t[e][i]={type:I.WALL}}return t}carvePassages(t,e,i){t[i][e].type=I.PATH;const n=[{dx:2,dy:0},{dx:0,dy:2},{dx:-2,dy:0},{dx:0,dy:-2}];this.shuffleArray(n);for(const a of n){const o=e+a.dx,h=i+a.dy;o>0&&o<this.width-1&&h>0&&h<this.height-1&&t[h][o].type===I.WALL&&(t[i+a.dy/2][e+a.dx/2].type=I.PATH,this.carvePassages(t,o,h))}}shuffleArray(t){for(let e=t.length-1;e>0;e--){const i=Math.floor(Math.random()*(e+1));[t[e],t[i]]=[t[i],t[e]]}}isValidMaze(t,e,i){const n=new Set,a=[e];for(n.add(`${e.x},${e.y}`);a.length>0;){const o=a.shift();if(o.x===i.x&&o.y===i.y)return!0;const h=[{x:o.x+1,y:o.y},{x:o.x-1,y:o.y},{x:o.x,y:o.y+1},{x:o.x,y:o.y-1}];for(const l of h){const c=`${l.x},${l.y}`;!n.has(c)&&l.x>=0&&l.x<this.width&&l.y>=0&&l.y<this.height&&t[l.y][l.x].type===I.PATH&&(n.add(c),a.push(l))}}return!1}}const b=new k;class G{constructor(){this.canvas=null,this.ctx=null,this.animalImages={},this.foodImages={}}initialize(t){if(this.canvas=document.getElementById(t),!this.canvas){console.error(`Canvas element with ID "${t}" not found`);return}this.ctx=this.canvas.getContext("2d"),this.resizeCanvas()}resizeCanvas(){this.canvas&&(this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight)}clear(){this.ctx&&(this.ctx.fillStyle="#ECF0F1",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height))}calculateCellSize(t,e=40){if(!t||!t.grid||!this.canvas)return e;const i=t.grid,n=i[0].length,a=i.length,o=this.canvas.width-40,h=this.canvas.height-40,l=Math.floor(o/n),c=Math.floor(h/a),r=Math.min(l,c);return Math.max(5,Math.min(r,e))}renderMaze(t,e=40){if(!t||!t.grid)return;const i=this.calculateCellSize(t,e),n=t.grid,a=n[0].length,o=n.length,h=a*i,l=o*i,c=(this.canvas.width-h)/2,r=(this.canvas.height-l)/2;for(let f=0;f<o;f++)for(let g=0;g<a;g++){const d=n[f][g],x=c+g*i,m=r+f*i;d.type==="wall"?this.ctx.fillStyle="#2C3E50":this.ctx.fillStyle="#ECF0F1",this.ctx.fillRect(x,m,i,i),this.ctx.strokeStyle="#95A5A6",this.ctx.lineWidth=1,this.ctx.strokeRect(x,m,i,i)}this.currentCellSize=i,this.mazeOffsetX=c,this.mazeOffsetY=r}renderAnimal(t,e=40,i="#E74C3C"){if(!t)return;const n=t.x*e+e/2,a=t.y*e+e/2,o=e/3;this.ctx.fillStyle=i,this.ctx.beginPath(),this.ctx.arc(n,a,o,0,Math.PI*2),this.ctx.fill()}async loadAnimalImage(t){return this.animalImages[t]?this.animalImages[t]:new Promise(e=>{const i=new Image;i.onload=()=>{this.animalImages[t]=i,e(i)},i.onerror=()=>{console.warn(`Failed to load animal image for ${t}`),e(null)},i.src=`/assets/icons/${t}.svg`})}async loadFoodImage(t){return this.foodImages[t]?this.foodImages[t]:new Promise(e=>{const i=new Image;i.onload=()=>{this.foodImages[t]=i,e(i)},i.onerror=()=>{console.warn(`Failed to load food image for ${t}`),e(null)},i.src=`/assets/icons/foods/${t}.svg`})}renderAnimalIcon(t,e,i=40){if(!t||!e)return;const n=this.currentCellSize||i,a=this.mazeOffsetX||0,o=this.mazeOffsetY||0,h=a+e.x*n,l=o+e.y*n,c=Math.max(1,Math.floor(n/8)),r=n-c*2;this.ctx.drawImage(t,h+c,l+c,r,r)}renderFoodIcon(t,e,i=40){if(!t||!e)return;const n=this.currentCellSize||i,a=this.mazeOffsetX||0,o=this.mazeOffsetY||0,h=a+e.x*n,l=o+e.y*n,c=Math.max(1,Math.floor(n/8)),r=n-c*2;this.ctx.drawImage(t,h+c,l+c,r,r)}renderGoal(t,e=40,i="#F39C12"){if(!t)return;const n=t.x*e+e/2,a=t.y*e+e/2,o=e/2.5;this.ctx.fillStyle=i,this.ctx.fillRect(n-o/2,a-o/2,o,o)}renderAnimalSelection(t){this.clear()}renderCompletion(t,e=0){if(this.clear(),this.ctx.fillStyle="#2C3E50",this.ctx.font="bold 56px Arial",this.ctx.textAlign="center",this.ctx.fillText("üéâ You Won! üéâ",this.canvas.width/2,100),this.ctx.font="28px Arial",this.ctx.fillStyle="#E74C3C",this.ctx.fillText(`Great job, ${t}!`,this.canvas.width/2,170),e>0){this.ctx.font="20px Arial",this.ctx.fillStyle="#2C3E50";const i=Math.floor(e/60),n=Math.round(e%60),a=`Time: ${i}m ${n}s`;this.ctx.fillText(a,this.canvas.width/2,230)}this.ctx.font="italic 18px Arial",this.ctx.fillStyle="#7F8C8D",this.ctx.fillText("Goal reached! üèÅ",this.canvas.width/2,280)}}const s=new G;class O{constructor(){this.isDragging=!1,this.startPosition=null,this.currentPosition=null,this.onMove=null,this.onEnd=null}bind(t,e,i){this.onMove=e,this.onEnd=i,t.addEventListener("touchstart",n=>this.handleStart(n),!1),t.addEventListener("touchmove",n=>this.handleMove(n),!1),t.addEventListener("touchend",n=>this.handleEnd(n),!1),t.addEventListener("mousedown",n=>this.handleStart(n),!1),t.addEventListener("mousemove",n=>this.handleMove(n),!1),t.addEventListener("mouseup",n=>this.handleEnd(n),!1)}handleStart(t){this.isDragging=!0,this.startPosition=this.getPosition(t),this.currentPosition=this.startPosition}handleMove(t){this.isDragging&&(t.preventDefault(),this.currentPosition=this.getPosition(t),this.onMove&&this.onMove({start:this.startPosition,current:this.currentPosition,delta:{x:this.currentPosition.x-this.startPosition.x,y:this.currentPosition.y-this.startPosition.y}}))}handleEnd(t){this.isDragging&&(this.isDragging=!1,this.onEnd&&this.onEnd({start:this.startPosition,end:this.currentPosition,distance:{x:this.currentPosition.x-this.startPosition.x,y:this.currentPosition.y-this.startPosition.y}}),this.startPosition=null,this.currentPosition=null)}getPosition(t){let e,i;return t.touches&&t.touches.length>0?(e=t.touches[0].clientX,i=t.touches[0].clientY):(e=t.clientX,i=t.clientY),{x:e,y:i}}resetDragState(){this.isDragging&&(this.isDragging=!1,this.startPosition=null,this.currentPosition=null)}}const _=new O;class X{constructor(){this.audio=null,this.isMuted=!1}initialize(t){try{this.audio=new Audio(t),this.audio.loop=!0,this.audio.volume=.3,console.log(`üîä Audio initialized: ${t}`)}catch(e){console.error("‚ùå Audio initialization error:",e),this.audio=null}}play(){if(!this.audio)return console.warn("‚ö†Ô∏è Audio not initialized"),Promise.resolve();if(this.isMuted)return console.log("üîá Audio is muted, not playing"),Promise.resolve();try{const t=this.audio.play();return t&&typeof t.catch=="function"?t.catch(e=>{console.warn("‚ö†Ô∏è Audio playback failed:",e.message)}):Promise.resolve()}catch(t){return console.warn("‚ö†Ô∏è Audio play error:",t),Promise.reject(t)}}pause(){this.audio&&this.audio.pause()}stop(){this.audio&&(this.audio.pause(),this.audio.currentTime=0)}mute(){this.isMuted=!0,this.audio&&(this.audio.muted=!0)}unmute(){this.isMuted=!1,this.audio&&(this.audio.muted=!1)}toggleMute(){return this.isMuted?this.unmute():this.mute(),this.isMuted}setVolume(t){this.audio&&(this.audio.volume=Math.max(0,Math.min(1,t)))}getMuteState(){return this.isMuted}}const v=new X;class R{constructor(){this.container=null,this.canvas=null,this.isInitialized=!1,this.selectedAnimalForDisplay=null,this.isGeneratingMaze=!1,this.animalImages={},this.animationFrameId=null}async initialize(){console.log("üéÆ Initializing Mavis Animal Maze..."),this.setupDOM(),await this.initializeModules(),this.loadAssets(),await this.showAnimalSelection(),this.isInitialized=!0,console.log("‚úÖ Application initialized")}setupDOM(){const t=document.getElementById("app");if(!t){console.error("App container not found");return}t.innerHTML=`
      <div id="game-container" class="game-container">
        <div id="game-ui" class="game-ui">
          <div id="audio-control" class="audio-control">
            <button id="mute-button" class="mute-button" title="Toggle Music">üîä</button>
          </div>
        </div>
        <canvas id="game-canvas" class="game-canvas" width="800" height="600"></canvas>
      </div>
    `,this.container=t,this.canvas=document.getElementById("game-canvas"),s.initialize("game-canvas"),this.setupEventListeners()}setupEventListeners(){const t=document.getElementById("mute-button");t&&t.addEventListener("click",()=>{const i=v.toggleMute();t.textContent=i?"üîá":"üîä",!i&&v.audio&&v.play()});const e=()=>{console.log("üîì User interaction detected - unlocking audio"),v.play().catch(()=>{console.log("Audio play attempted on user interaction")}),document.removeEventListener("click",e),document.removeEventListener("touchstart",e)};document.addEventListener("click",e,{once:!0}),document.addEventListener("touchstart",e,{once:!0}),window.addEventListener("resize",()=>{s.resizeCanvas(),this.render()}),this.canvas.addEventListener("click",i=>this.handleCanvasClick(i)),this.canvas.addEventListener("touchstart",i=>this.handleCanvasTouch(i),!1)}async initializeModules(){console.log("Initializing modules...");try{const t=P.BACKGROUND_MUSIC_PATH.startsWith("/")?P.BACKGROUND_MUSIC_PATH:`/assets/audio/${P.BACKGROUND_MUSIC_PATH}`;v.initialize(t),console.log("‚úÖ Audio initialized")}catch(t){console.warn("‚ö†Ô∏è Audio initialization failed:",t)}}loadAssets(){console.log("Assets ready")}async showAnimalSelection(){console.log("Showing animal selection..."),u.setState(w.SELECTION),u.reset(),s.clear(),s.renderAnimalSelection(E.getAllAnimals()),await this.drawAnimalButtons(),this.attemptAudioPlayback()}attemptAudioPlayback(t=1){if(!v.audio){console.warn("‚ö†Ô∏è Audio not initialized");return}v.play().catch(e=>{const i=(e==null?void 0:e.message)||String(e);console.log(`üîä Audio play attempt ${t} failed: ${i}`),i.includes("user")||i.includes("interact")?console.log("‚ÑπÔ∏è Browser autoplay policy: waiting for user interaction..."):t<P.AUTO_PLAY_ATTEMPTS?(console.log(`Retrying audio playback (${t}/${P.AUTO_PLAY_ATTEMPTS})...`),setTimeout(()=>{this.attemptAudioPlayback(t+1)},P.AUTO_PLAY_DELAY_MS)):console.warn("‚ö†Ô∏è Audio autoplay failed. Audio will start after user interacts with page.")})}async loadAnimalImage(t){return this.animalImages[t]?this.animalImages[t]:new Promise(e=>{const i=new Image;i.onload=()=>{this.animalImages[t]=i,e(i)},i.onerror=()=>{console.warn(`Failed to load image for ${t}`),e(null)},i.src=`/assets/icons/${t}.svg`})}drawAnimalIcon(t,e,i,n){if(!t)return;const a=10,o=n-a*2,h=e+a,l=i+a;try{s.ctx.drawImage(t,h,l,o,o)}catch(c){console.warn("Error drawing animal image:",c)}}async drawAnimalButtons(){const t=E.getAllAnimals(),e=5,i=90,n=15,a=25,h=i+a+20,l=(this.canvas.width-(e*(i+n)-n))/2,c=100;s.ctx.fillStyle="#2C3E50",s.ctx.font="bold 32px Arial",s.ctx.textAlign="center",s.ctx.fillText("Choose Your Animal Friend!",this.canvas.width/2,50),this.animalButtons=[];const r=t.map(d=>this.loadAnimalImage(d.name)),f=await Promise.all(r);t.forEach((d,x)=>{const m=Math.floor(x/e),M=x%e,y=l+M*(i+n),p=c+m*h,A=this.selectedAnimalForDisplay===d.name,L=this.isGeneratingMaze&&!A;A?s.ctx.fillStyle="#2ECC71":L?s.ctx.fillStyle="#BDC3C7":s.ctx.fillStyle="#FF6B6B",s.ctx.shadowColor=A?"rgba(46, 204, 113, 0.4)":"rgba(0, 0, 0, 0.2)",s.ctx.shadowBlur=A?12:8,s.ctx.shadowOffsetY=4,s.ctx.fillRect(y,p,i,i),s.ctx.shadowColor="transparent",A?(s.ctx.strokeStyle="#27AE60",s.ctx.lineWidth=6):L?(s.ctx.strokeStyle="#95A5A6",s.ctx.lineWidth=3):(s.ctx.strokeStyle="#E74C3C",s.ctx.lineWidth=4),s.ctx.strokeRect(y,p,i,i);const z=f[x];z&&this.drawAnimalIcon(z,y,p,i),A&&this.isGeneratingMaze&&this.drawLoadingSpinner(y+i/2,p+i/2,15),s.ctx.fillStyle=L?"#95A5A6":"#2C3E50",s.ctx.font=A?"bold 13px Arial":"bold 12px Arial",s.ctx.textAlign="center",s.ctx.textBaseline="middle";const D=p+i+a/2;s.ctx.fillText(d.name.charAt(0).toUpperCase()+d.name.slice(1),y+i/2,D),this.animalButtons.push({x:y,y:p,width:i,height:i,animal:d.name})}),s.ctx.fillStyle=this.isGeneratingMaze?"#E74C3C":"#7F8C8D",s.ctx.font="italic 14px Arial",s.ctx.textAlign="center";const g=this.isGeneratingMaze?"üåÄ Generating your maze adventure...":"Tap an animal to start your maze adventure!";s.ctx.fillText(g,this.canvas.width/2,this.canvas.height-30)}drawLoadingSpinner(t,e,i){const a=Date.now()%1e3/1e3*Math.PI*2;s.ctx.save(),s.ctx.translate(t,e),s.ctx.rotate(a),s.ctx.strokeStyle="#2ECC71",s.ctx.lineWidth=3,s.ctx.beginPath(),s.ctx.arc(0,0,i,0,Math.PI*1.5),s.ctx.stroke(),s.ctx.restore()}handleCanvasClick(t){if(u.getState()!==w.SELECTION)return;const e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,n=t.clientY-e.top;if(this.animalButtons){for(const a of this.animalButtons)if(i>=a.x&&i<=a.x+a.width&&n>=a.y&&n<=a.y+a.height){this.selectAnimal(a.animal);break}}}handleCanvasTouch(t){if(u.getState()!==w.SELECTION)return;const e=this.canvas.getBoundingClientRect(),i=t.touches[0],n=i.clientX-e.left,a=i.clientY-e.top;if(this.animalButtons){for(const o of this.animalButtons)if(n>=o.x&&n<=o.x+o.width&&a>=o.y&&a<=o.y+o.height){t.preventDefault(),this.selectAnimal(o.animal);break}}}showDifficultySelection(){console.log("Showing difficulty selection..."),u.setState(w.DIFFICULTY),s.clear();const t=[C.EASY,C.MEDIUM,C.HARD];this.drawDifficultyButtons(t)}async drawDifficultyButtons(t){const a=t.length*180+(t.length-1)*30,o=(this.canvas.width-a)/2,h=150;s.ctx.fillStyle="#2C3E50",s.ctx.font="bold 32px Arial",s.ctx.textAlign="center",s.ctx.fillText("Choose Difficulty Level",this.canvas.width/2,80),s.ctx.fillStyle="#7F8C8D",s.ctx.font="italic 16px Arial",s.ctx.fillText("Select how challenging your maze adventure should be",this.canvas.width/2,110),this.difficultyButtons=[],t.forEach((l,c)=>{const r=o+c*210,f=h;s.ctx.fillStyle=l.color,s.ctx.shadowColor="rgba(0, 0, 0, 0.2)",s.ctx.shadowBlur=8,s.ctx.shadowOffsetY=4,s.ctx.fillRect(r,f,180,120),s.ctx.shadowColor="transparent",s.ctx.strokeStyle="#2C3E50",s.ctx.lineWidth=3,s.ctx.strokeRect(r,f,180,120),s.ctx.fillStyle="#FFFFFF",s.ctx.font="bold 40px Arial",s.ctx.textAlign="center",s.ctx.textBaseline="middle",s.ctx.fillText(l.emoji,r+180/2,f+35),s.ctx.fillStyle="#2C3E50",s.ctx.font="bold 18px Arial",s.ctx.textAlign="center",s.ctx.textBaseline="middle",s.ctx.fillText(l.label,r+180/2,f+70),s.ctx.fillStyle="#2C3E50",s.ctx.font="12px Arial",s.ctx.textAlign="center",s.ctx.textBaseline="middle",this.wrapText(l.description,170).forEach((d,x)=>{s.ctx.fillText(d,r+180/2,f+90+x*12)}),this.difficultyButtons.push({x:r,y:f,width:180,height:120,difficulty:l.id})}),this.canvas.onclick=l=>{const c=this.canvas.getBoundingClientRect(),r=l.clientX-c.left,f=l.clientY-c.top;if(this.difficultyButtons){for(const g of this.difficultyButtons)if(r>=g.x&&r<=g.x+g.width&&f>=g.y&&f<=g.y+g.height){this.selectDifficulty(g.difficulty);break}}},this.canvas.addEventListener("touchstart",l=>{if(u.getState()!==w.DIFFICULTY)return;const c=this.canvas.getBoundingClientRect(),r=l.touches[0],f=r.clientX-c.left,g=r.clientY-c.top;if(this.difficultyButtons){for(const d of this.difficultyButtons)if(f>=d.x&&f<=d.x+d.width&&g>=d.y&&g<=d.y+d.height){l.preventDefault(),this.selectDifficulty(d.difficulty);break}}},!1)}wrapText(t,e){const i=t.split(" "),n=[];let a="";for(const o of i){const h=a+(a?" ":"")+o;s.ctx.measureText(h).width>e&&a?(n.push(a),a=o):a=h}return a&&n.push(a),n}async selectDifficulty(t){console.log(`üéØ Selected difficulty: ${t}`);let e=null;if(t==="easy"?e=C.EASY:t==="medium"?e=C.MEDIUM:t==="hard"&&(e=C.HARD),!e){console.error(`Invalid difficulty: ${t}`);return}u.selectDifficulty(t),u.setState(w.PLAYING),u.startSession();let i=b.generate(e.width,e.height),n=0;for(;!b.isValidMaze(i.grid,i.start,i.goal)&&n<3;)console.log(`Maze validation failed (attempt ${n+1}/3), regenerating...`),i=b.generate(e.width,e.height),n++;if(!b.isValidMaze(i.grid,i.start,i.goal)){console.error("Failed to generate valid maze after 3 attempts"),await this.showAnimalSelection();return}u.setMaze(i),u.setPlayerPosition(i.start),setTimeout(()=>{this.startGameplay()},500)}async selectAnimal(t){if(console.log(`‚ú® Selected: ${t}`),!E.isValidAnimal(t)){console.error(`Invalid animal: ${t}`);return}this.selectedAnimalForDisplay=t,this.isGeneratingMaze=!0,s.clear(),s.renderAnimalSelection(E.getAllAnimals()),await this.drawAnimalButtons();const e=async()=>{this.isGeneratingMaze&&(s.clear(),s.renderAnimalSelection(E.getAllAnimals()),await this.drawAnimalButtons(),requestAnimationFrame(e))};e(),u.selectAnimal(t),setTimeout(()=>{this.isGeneratingMaze=!1,this.selectedAnimalForDisplay=null,this.showDifficultySelection()},500)}async startGameplay(){console.log("Starting gameplay..."),this.isGeneratingMaze=!1,this.selectedAnimalForDisplay=null;const t=u.getSelectedAnimal();if(t){await s.loadAnimalImage(t);const e=E.getFoodForAnimal(t);e&&await s.loadFoodImage(e)}v.audio&&v.play(),_.bind(this.canvas,e=>this.handleMovement(e),e=>this.handleMovementEnd(e)),this.render(),this.gameLoop()}gameLoop(){this.render(),this.animationFrameId=requestAnimationFrame(()=>this.gameLoop())}handleMovement(t){const e=u.getMaze();if(!e||!t.current)return;const i=this.canvas.getBoundingClientRect(),n=this.canvas.width/i.width,a=this.canvas.height/i.height,o=(t.current.x-i.left)*n,h=(t.current.y-i.top)*a,l=s.currentCellSize||T.CELL_SIZE,c=s.mazeOffsetX||0,r=s.mazeOffsetY||0,f=o-c,g=h-r;let d=Math.floor(f/l),x=Math.floor(g/l);const m=u.getPlayerPosition();let M=0,y=0;if(d!==m.x&&(M=d>m.x?1:-1),x!==m.y&&(y=x>m.y?1:-1),M!==0&&y!==0){const L=Math.abs(d-m.x),z=Math.abs(x-m.y);L>z?y=0:M=0}const p=m.x+M,A=m.y+y;if(p===m.x&&A===m.y){this.render();return}if(!this.isValidMove(e,p,A)){this.render();return}u.setPlayerPosition({x:p,y:A}),u.isAtGoal()&&this.completeGame(),this.render()}isValidMove(t,e,i){return e<0||e>=t.grid[0].length||i<0||i>=t.grid.length?!1:t.grid[i][e].type==="path"}handleMovementEnd(t){this.render()}completeGame(){console.log("üéâ Game completed!"),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),u.setState(w.COMPLETED),u.endSession(),v.pause();const t=u.getSelectedAnimal(),e=u.getSessionDuration();s.renderCompletion(t,e),this.drawReplayButtons()}drawReplayButtons(){const t=this.canvas.width,e=this.canvas.height,i=150,n=50,a=20,o=t/2-i-a/2,h=e-100,l=t/2+a/2,c=e-100;s.ctx.fillStyle="#2ECC71",s.ctx.fillRect(o,h,i,n),s.ctx.fillStyle="#FFFFFF",s.ctx.font="bold 16px Arial",s.ctx.textAlign="center",s.ctx.fillText("Play Again",o+i/2,h+32),s.ctx.fillStyle="#E74C3C",s.ctx.fillRect(l,c,i,n),s.ctx.fillStyle="#FFFFFF",s.ctx.fillText("Quit",l+i/2,c+32),this.replayButtons=[{x:o,y:h,width:i,height:n,action:"play"},{x:l,y:c,width:i,height:n,action:"quit"}];const r=f=>{const g=this.canvas.getBoundingClientRect(),d=f.clientX-g.left,x=f.clientY-g.top;for(const m of this.replayButtons)if(d>=m.x&&d<=m.x+m.width&&x>=m.y&&x<=m.y+m.height){this.canvas.removeEventListener("click",r),m.action==="play"?this.showAnimalSelection():this.quit();break}};this.canvas.onclick=r}quit(){console.log("Quitting game..."),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),s.clear(),s.ctx.fillStyle="#2C3E50",s.ctx.font="32px Arial",s.ctx.textAlign="center",s.ctx.fillText("Thanks for playing!",this.canvas.width/2,this.canvas.height/2)}render(){if(u.getState()===w.PLAYING){const e=u.getMaze(),i=u.getPlayerPosition(),n=u.getSelectedAnimal();if(s.clear(),s.renderMaze(e,T.CELL_SIZE),n){const a=E.getFoodForAnimal(n);a&&s.foodImages[a]&&s.renderFoodIcon(s.foodImages[a],e.goal,T.CELL_SIZE)}n&&s.animalImages[n]&&s.renderAnimalIcon(s.animalImages[n],i,T.CELL_SIZE)}}}document.addEventListener("DOMContentLoaded",()=>{new R().initialize()});
