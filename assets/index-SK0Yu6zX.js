(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(n){if(n.ep)return;n.ep=!0;const o=e(n);fetch(n.href,o)}})();const b=[{name:"rabbit",food:"carrot"},{name:"monkey",food:"banana"},{name:"elephant",food:"peanut"},{name:"cat",food:"fish"},{name:"dog",food:"fish"},{name:"goldfish",food:"plankton"},{name:"bear",food:"honey"},{name:"turtle",food:"leafy"},{name:"jellyfish",food:"plankton"},{name:"whale",food:"krill"}],z={CELL_SIZE:40},M={EASY:{id:"easy",label:"Easy",description:"Small maze - Quick adventure",width:15,height:15,color:"#2ECC71",emoji:"üå±"},MEDIUM:{id:"medium",label:"Medium",description:"Medium maze - Challenge yourself",width:21,height:21,color:"#F39C12",emoji:"üåø"},HARD:{id:"hard",label:"Hard",description:"Large maze - Expert challenge",width:27,height:27,color:"#E74C3C",emoji:"üå≥"}},v={SELECTION:"selection",DIFFICULTY:"difficulty",PLAYING:"playing",COMPLETED:"completed"},L={WALL:"wall",PATH:"path"},F={ENABLED:!0,DEFAULT_VOLUME:.3,BACKGROUND_MUSIC_PATH:"/assets/audio/background-music.wav",AUTO_PLAY_ATTEMPTS:3,AUTO_PLAY_DELAY_MS:500};class B{constructor(){this.reset()}reset(){this.currentState=v.SELECTION,this.selectedAnimal=null,this.selectedDifficulty=null,this.maze=null,this.playerPosition=null,this.sessionStartTime=null,this.sessionEndTime=null}_isValidAnimal(t){return!t||typeof t!="string"?!1:b.some(e=>e.name.toLowerCase()===t.toLowerCase())}selectAnimal(t){this._isValidAnimal(t)&&(this.selectedAnimal=t.toLowerCase())}getSelectedAnimal(){return this.selectedAnimal}selectDifficulty(t){this.selectedDifficulty=t}getSelectedDifficulty(){return this.selectedDifficulty}setMaze(t){this.maze=t}getMaze(){return this.maze}setPlayerPosition(t){this.playerPosition=t}getPlayerPosition(){return this.playerPosition}setState(t){this.currentState=t}getState(){return this.currentState}isAtGoal(){return!this.playerPosition||!this.maze||!this.maze.goal?!1:this.playerPosition.x===this.maze.goal.x&&this.playerPosition.y===this.maze.goal.y}startSession(){this.sessionStartTime=Date.now()}endSession(){this.sessionEndTime=Date.now()}getSessionDuration(){return!this.sessionStartTime||!this.sessionEndTime?0:(this.sessionEndTime-this.sessionStartTime)/1e3}getSnapshot(){return{gameState:this.currentState,currentState:this.currentState,selectedAnimal:this.selectedAnimal,maze:this.maze,playerPosition:this.playerPosition,sessionStartTime:this.sessionStartTime,sessionEndTime:this.sessionEndTime}}}const d=new B;class Y{constructor(){this.animals=b}getAllAnimals(){return this.animals}getAnimalByName(t){return!t||typeof t!="string"?null:this.animals.find(e=>e.name.toLowerCase()===t.toLowerCase())||null}getFoodForAnimal(t){const e=this.getAnimalByName(t);return e?e.food:null}getAnimalIconPath(t){return`/src/assets/icons/${t}.svg`}getFoodIconPath(t){return`/src/assets/icons/foods/${t}.svg`}isValidAnimal(t){return!t||typeof t!="string"?!1:this.getAnimalByName(t)!==null}}const S=new Y;class k{constructor(){this.width=15,this.height=15}generate(t=15,e=15){this.width=t,this.height=e;const i=this.initializeGrid();this.carvePassages(i,1,1);const n={x:1,y:1},o={x:t-2,y:e-2};return{grid:i,start:n,goal:o,width:t,height:e}}initializeGrid(){const t=[];for(let e=0;e<this.height;e++){t[e]=[];for(let i=0;i<this.width;i++)t[e][i]={type:L.WALL}}return t}carvePassages(t,e,i){t[i][e].type=L.PATH;const n=[{dx:2,dy:0},{dx:0,dy:2},{dx:-2,dy:0},{dx:0,dy:-2}];this.shuffleArray(n);for(const o of n){const a=e+o.dx,c=i+o.dy;a>0&&a<this.width-1&&c>0&&c<this.height-1&&t[c][a].type===L.WALL&&(t[i+o.dy/2][e+o.dx/2].type=L.PATH,this.carvePassages(t,a,c))}}shuffleArray(t){for(let e=t.length-1;e>0;e--){const i=Math.floor(Math.random()*(e+1));[t[e],t[i]]=[t[i],t[e]]}}isValidMaze(t,e,i){const n=new Set,o=[e];for(n.add(`${e.x},${e.y}`);o.length>0;){const a=o.shift();if(a.x===i.x&&a.y===i.y)return!0;const c=[{x:a.x+1,y:a.y},{x:a.x-1,y:a.y},{x:a.x,y:a.y+1},{x:a.x,y:a.y-1}];for(const l of c){const r=`${l.x},${l.y}`;!n.has(r)&&l.x>=0&&l.x<this.width&&l.y>=0&&l.y<this.height&&t[l.y][l.x].type===L.PATH&&(n.add(r),o.push(l))}}return!1}}const T=new k;class G{constructor(){this.canvas=null,this.ctx=null,this.animalImages={},this.foodImages={}}initialize(t){if(this.canvas=document.getElementById(t),!this.canvas){console.error(`Canvas element with ID "${t}" not found`);return}this.ctx=this.canvas.getContext("2d"),this.resizeCanvas()}resizeCanvas(){this.canvas&&(this.canvas.width=this.canvas.offsetWidth,this.canvas.height=this.canvas.offsetHeight)}clear(){this.ctx&&(this.ctx.fillStyle="#ECF0F1",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height))}calculateCellSize(t,e=40){if(!t||!t.grid||!this.canvas)return e;const i=t.grid,n=i[0].length,o=i.length,a=this.canvas.width-40,c=this.canvas.height-40,l=Math.floor(a/n),r=Math.floor(c/o),h=Math.min(l,r);return Math.max(5,Math.min(h,e))}renderMaze(t,e=40){if(!t||!t.grid)return;const i=this.calculateCellSize(t,e),n=t.grid,o=n[0].length,a=n.length,c=o*i,l=a*i,r=(this.canvas.width-c)/2,h=(this.canvas.height-l)/2;for(let f=0;f<a;f++)for(let g=0;g<o;g++){const u=n[f][g],y=r+g*i,m=h+f*i;u.type==="wall"?this.ctx.fillStyle="#2C3E50":this.ctx.fillStyle="#ECF0F1",this.ctx.fillRect(y,m,i,i),this.ctx.strokeStyle="#95A5A6",this.ctx.lineWidth=1,this.ctx.strokeRect(y,m,i,i)}this.currentCellSize=i,this.mazeOffsetX=r,this.mazeOffsetY=h}renderAnimal(t,e=40,i="#E74C3C"){if(!t)return;const n=t.x*e+e/2,o=t.y*e+e/2,a=e/3;this.ctx.fillStyle=i,this.ctx.beginPath(),this.ctx.arc(n,o,a,0,Math.PI*2),this.ctx.fill()}async loadAnimalImage(t){return this.animalImages[t]?this.animalImages[t]:new Promise(e=>{const i=new Image;i.onload=()=>{this.animalImages[t]=i,e(i)},i.onerror=()=>{console.warn(`Failed to load animal image for ${t}`),e(null)},i.src=`/mavisAnimalMazeGame/assets/icons/${t}.svg`})}async loadFoodImage(t){return this.foodImages[t]?this.foodImages[t]:new Promise(e=>{const i=new Image;i.onload=()=>{this.foodImages[t]=i,e(i)},i.onerror=()=>{console.warn(`Failed to load food image for ${t}`),e(null)},i.src=`/mavisAnimalMazeGame/assets/icons/foods/${t}.svg`})}renderAnimalIcon(t,e,i=40){if(!t||!e)return;const n=this.currentCellSize||i,o=this.mazeOffsetX||0,a=this.mazeOffsetY||0,c=o+e.x*n,l=a+e.y*n,r=Math.max(1,Math.floor(n/8)),h=n-r*2;this.ctx.drawImage(t,c+r,l+r,h,h)}renderFoodIcon(t,e,i=40){if(!t||!e)return;const n=this.currentCellSize||i,o=this.mazeOffsetX||0,a=this.mazeOffsetY||0,c=o+e.x*n,l=a+e.y*n,r=Math.max(1,Math.floor(n/8)),h=n-r*2;this.ctx.drawImage(t,c+r,l+r,h,h)}renderGoal(t,e=40,i="#F39C12"){if(!t)return;const n=t.x*e+e/2,o=t.y*e+e/2,a=e/2.5;this.ctx.fillStyle=i,this.ctx.fillRect(n-a/2,o-a/2,a,a)}renderAnimalSelection(t){this.clear()}renderCompletion(t,e=0){if(this.clear(),this.ctx.fillStyle="#2C3E50",this.ctx.font="bold 56px Arial",this.ctx.textAlign="center",this.ctx.fillText("üéâ You Won! üéâ",this.canvas.width/2,100),this.ctx.font="28px Arial",this.ctx.fillStyle="#E74C3C",this.ctx.fillText(`Great job, ${t}!`,this.canvas.width/2,170),e>0){this.ctx.font="20px Arial",this.ctx.fillStyle="#2C3E50";const i=Math.floor(e/60),n=Math.round(e%60),o=`Time: ${i}m ${n}s`;this.ctx.fillText(o,this.canvas.width/2,230)}this.ctx.font="italic 18px Arial",this.ctx.fillStyle="#7F8C8D",this.ctx.fillText("Goal reached! üèÅ",this.canvas.width/2,280)}}const s=new G;class O{constructor(){this.isDragging=!1,this.startPosition=null,this.currentPosition=null,this.onMove=null,this.onEnd=null}bind(t,e,i){this.onMove=e,this.onEnd=i,t.addEventListener("touchstart",n=>this.handleStart(n),!1),t.addEventListener("touchmove",n=>this.handleMove(n),!1),t.addEventListener("touchend",n=>this.handleEnd(n),!1),t.addEventListener("mousedown",n=>this.handleStart(n),!1),t.addEventListener("mousemove",n=>this.handleMove(n),!1),t.addEventListener("mouseup",n=>this.handleEnd(n),!1)}handleStart(t){this.isDragging=!0,this.startPosition=this.getPosition(t),this.currentPosition=this.startPosition}handleMove(t){this.isDragging&&(t.preventDefault(),this.currentPosition=this.getPosition(t),this.onMove&&this.onMove({start:this.startPosition,current:this.currentPosition,delta:{x:this.currentPosition.x-this.startPosition.x,y:this.currentPosition.y-this.startPosition.y}}))}handleEnd(t){this.isDragging&&(this.isDragging=!1,this.onEnd&&this.onEnd({start:this.startPosition,end:this.currentPosition,distance:{x:this.currentPosition.x-this.startPosition.x,y:this.currentPosition.y-this.startPosition.y}}),this.startPosition=null,this.currentPosition=null)}getPosition(t){let e,i;return t.touches&&t.touches.length>0?(e=t.touches[0].clientX,i=t.touches[0].clientY):(e=t.clientX,i=t.clientY),{x:e,y:i}}resetDragState(){this.isDragging&&(this.isDragging=!1,this.startPosition=null,this.currentPosition=null)}}const R=new O;class _{constructor(){this.audio=null,this.isMuted=!1}initialize(t){try{this.audio=document.createElement("audio"),this.audio.loop=!0,this.audio.volume=.3,this.audio.preload="auto",this.audio.crossOrigin="anonymous";const e=t.replace(/\.[^.]+$/,"");[{src:`${e}.wav`,type:"audio/wav"},{src:`${e}.mp3`,type:"audio/mpeg"},{src:`${e}.ogg`,type:"audio/ogg"}].forEach(n=>{const o=document.createElement("source");o.src=n.src,o.type=n.type,this.audio.appendChild(o)}),this.audio.style.display="none",document.body.appendChild(this.audio),this.audio.addEventListener("loadstart",()=>{console.log("üîä Audio loading started...")}),this.audio.addEventListener("loadedmetadata",()=>{console.log("‚úÖ Audio metadata loaded, duration:",this.audio.duration,"seconds"),console.log("   Current source:",this.audio.currentSrc)}),this.audio.addEventListener("canplay",()=>{console.log("‚úÖ Audio ready to play")}),this.audio.addEventListener("canplaythrough",()=>{console.log("‚úÖ Audio can play through without buffering")}),this.audio.addEventListener("playing",()=>{console.log("‚ñ∂Ô∏è  Audio is playing")}),this.audio.addEventListener("pause",()=>{console.log("‚è∏Ô∏è  Audio paused")}),this.audio.addEventListener("ended",()=>{console.log("‚èπÔ∏è  Audio ended (should loop)")}),this.audio.addEventListener("error",n=>{var c;const o=(c=this.audio.error)==null?void 0:c.code,a=["Unknown error","MEDIA_ERR_ABORTED","MEDIA_ERR_NETWORK","MEDIA_ERR_DECODE","MEDIA_ERR_SRC_NOT_SUPPORTED"][o]||"Unknown";console.error(`‚ùå Audio error (${a}):`,n),console.error("   Path:",t),console.error("   Current source:",this.audio.currentSrc)}),console.log(`üîä Audio initialized: ${t}`),console.log("   Trying formats: WAV ‚Üí MP3 ‚Üí OGG")}catch(e){console.error("‚ùå Audio initialization error:",e),this.audio=null}}play(){if(!this.audio)return console.warn("‚ö†Ô∏è Audio not initialized"),Promise.resolve();if(this.isMuted)return console.log("üîá Audio is muted, not playing"),Promise.resolve();try{const t=this.audio.play();return t&&typeof t.then=="function"?t.then(()=>(console.log("‚ñ∂Ô∏è Audio playing"),Promise.resolve())).catch(e=>{const i=e.message||String(e);return console.warn("‚ö†Ô∏è Audio playback failed:",i),i.toLowerCase().includes("user")||i.toLowerCase().includes("interact")?(console.info("‚ÑπÔ∏è Autoplay blocked - waiting for user interaction"),console.log("   Attempting retry in 100ms..."),new Promise(n=>{setTimeout(()=>{var a;const o=(a=this.audio)==null?void 0:a.play();if(o!=null&&o.catch)return o.then(n).catch(()=>n());n()},100)})):Promise.resolve()}):Promise.resolve()}catch(t){return console.warn("‚ö†Ô∏è Audio play error:",t),Promise.resolve()}}pause(){this.audio&&this.audio.pause()}stop(){this.audio&&(this.audio.pause(),this.audio.currentTime=0)}mute(){this.isMuted=!0,this.audio&&(this.audio.muted=!0)}unmute(){this.isMuted=!1,this.audio&&(this.audio.muted=!1)}toggleMute(){return this.isMuted?this.unmute():this.mute(),this.isMuted}setVolume(t){this.audio&&(this.audio.volume=Math.max(0,Math.min(1,t)))}getMuteState(){return this.isMuted}}const E=new _;class W{constructor(){this.container=null,this.canvas=null,this.isInitialized=!1,this.selectedAnimalForDisplay=null,this.isGeneratingMaze=!1,this.animalImages={},this.animationFrameId=null}async initialize(){console.log("üéÆ Initializing Mavis Animal Maze..."),this.setupDOM(),await this.initializeModules(),this.loadAssets(),await this.showAnimalSelection(),this.isInitialized=!0,console.log("‚úÖ Application initialized")}setupDOM(){const t=document.getElementById("app");if(!t){console.error("App container not found");return}t.innerHTML=`
      <div id="game-container" class="game-container">
        <div id="game-ui" class="game-ui">
          <div id="audio-control" class="audio-control">
            <button id="mute-button" class="mute-button" title="Toggle Music">üîä</button>
          </div>
        </div>
        <canvas id="game-canvas" class="game-canvas" width="800" height="600"></canvas>
      </div>
    `,this.container=t,this.canvas=document.getElementById("game-canvas"),s.initialize("game-canvas"),this.setupEventListeners()}setupEventListeners(){const t=document.getElementById("mute-button");t&&t.addEventListener("click",()=>{const i=E.toggleMute();t.textContent=i?"üîá":"üîä",!i&&E.audio&&E.play()}),this.audioUnlocked=!1;const e=()=>{this.audioUnlocked||(console.log("üîì User interaction detected - unlocking audio"),this.audioUnlocked=!0,E.play().catch(i=>{console.log("Audio play attempted on user interaction:",i)}),document.removeEventListener("click",e),document.removeEventListener("touchstart",e))};document.addEventListener("click",e,{once:!1}),document.addEventListener("touchstart",e,{once:!1}),window.addEventListener("resize",()=>{s.resizeCanvas(),this.render()}),this.canvas.addEventListener("click",i=>this.handleCanvasClick(i)),this.canvas.addEventListener("touchstart",i=>this.handleCanvasTouch(i),!1)}async initializeModules(){console.log("Initializing modules...");try{const t=F.BACKGROUND_MUSIC_PATH.startsWith("/")?F.BACKGROUND_MUSIC_PATH:`/assets/audio/${F.BACKGROUND_MUSIC_PATH}`;E.initialize(t),console.log("‚úÖ Audio initialized")}catch(t){console.warn("‚ö†Ô∏è Audio initialization failed:",t)}}loadAssets(){console.log("Assets ready")}async showAnimalSelection(){console.log("Showing animal selection..."),d.setState(v.SELECTION),d.reset(),s.clear(),s.renderAnimalSelection(S.getAllAnimals()),await this.drawAnimalButtons(),this.audioUnlocked||console.log("‚ÑπÔ∏è Waiting for user interaction to start audio...")}async loadAnimalImage(t){return this.animalImages[t]?this.animalImages[t]:new Promise(e=>{const i=new Image;i.onload=()=>{this.animalImages[t]=i,e(i)},i.onerror=()=>{console.warn(`Failed to load image for ${t}`),e(null)},i.src=`/mavisAnimalMazeGame/assets/icons/${t}.svg`})}drawAnimalIcon(t,e,i,n){if(!t)return;const o=10,a=n-o*2,c=e+o,l=i+o;try{s.ctx.drawImage(t,c,l,a,a)}catch(r){console.warn("Error drawing animal image:",r)}}async drawAnimalButtons(){const t=S.getAllAnimals(),e=5,i=90,n=15,o=25,c=i+o+20,l=(this.canvas.width-(e*(i+n)-n))/2,r=100;s.ctx.fillStyle="#2C3E50",s.ctx.font="bold 32px Arial",s.ctx.textAlign="center",s.ctx.fillText("Choose Your Animal Friend!",this.canvas.width/2,50),this.animalButtons=[];const h=t.map(u=>this.loadAnimalImage(u.name)),f=await Promise.all(h);t.forEach((u,y)=>{const m=Math.floor(y/e),C=y%e,x=l+C*(i+n),A=r+m*c,p=this.selectedAnimalForDisplay===u.name,P=this.isGeneratingMaze&&!p;p?s.ctx.fillStyle="#2ECC71":P?s.ctx.fillStyle="#BDC3C7":s.ctx.fillStyle="#FF6B6B",s.ctx.shadowColor=p?"rgba(46, 204, 113, 0.4)":"rgba(0, 0, 0, 0.2)",s.ctx.shadowBlur=p?12:8,s.ctx.shadowOffsetY=4,s.ctx.fillRect(x,A,i,i),s.ctx.shadowColor="transparent",p?(s.ctx.strokeStyle="#27AE60",s.ctx.lineWidth=6):P?(s.ctx.strokeStyle="#95A5A6",s.ctx.lineWidth=3):(s.ctx.strokeStyle="#E74C3C",s.ctx.lineWidth=4),s.ctx.strokeRect(x,A,i,i);const I=f[y];I&&this.drawAnimalIcon(I,x,A,i),p&&this.isGeneratingMaze&&this.drawLoadingSpinner(x+i/2,A+i/2,15),s.ctx.fillStyle=P?"#95A5A6":"#2C3E50",s.ctx.font=p?"bold 13px Arial":"bold 12px Arial",s.ctx.textAlign="center",s.ctx.textBaseline="middle";const D=A+i+o/2;s.ctx.fillText(u.name.charAt(0).toUpperCase()+u.name.slice(1),x+i/2,D),this.animalButtons.push({x,y:A,width:i,height:i,animal:u.name})}),s.ctx.fillStyle=this.isGeneratingMaze?"#E74C3C":"#7F8C8D",s.ctx.font="italic 14px Arial",s.ctx.textAlign="center";const g=this.isGeneratingMaze?"üåÄ Generating your maze adventure...":"Tap an animal to start your maze adventure!";s.ctx.fillText(g,this.canvas.width/2,this.canvas.height-30)}drawLoadingSpinner(t,e,i){const o=Date.now()%1e3/1e3*Math.PI*2;s.ctx.save(),s.ctx.translate(t,e),s.ctx.rotate(o),s.ctx.strokeStyle="#2ECC71",s.ctx.lineWidth=3,s.ctx.beginPath(),s.ctx.arc(0,0,i,0,Math.PI*1.5),s.ctx.stroke(),s.ctx.restore()}handleCanvasClick(t){if(d.getState()!==v.SELECTION)return;const e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,n=t.clientY-e.top;if(this.animalButtons){for(const o of this.animalButtons)if(i>=o.x&&i<=o.x+o.width&&n>=o.y&&n<=o.y+o.height){this.selectAnimal(o.animal);break}}}handleCanvasTouch(t){if(d.getState()!==v.SELECTION)return;const e=this.canvas.getBoundingClientRect(),i=t.touches[0],n=i.clientX-e.left,o=i.clientY-e.top;if(this.animalButtons){for(const a of this.animalButtons)if(n>=a.x&&n<=a.x+a.width&&o>=a.y&&o<=a.y+a.height){t.preventDefault(),this.selectAnimal(a.animal);break}}}showDifficultySelection(){console.log("Showing difficulty selection..."),d.setState(v.DIFFICULTY),s.clear();const t=[M.EASY,M.MEDIUM,M.HARD];this.drawDifficultyButtons(t)}async drawDifficultyButtons(t){const o=t.length*180+(t.length-1)*30,a=(this.canvas.width-o)/2,c=150;s.ctx.fillStyle="#2C3E50",s.ctx.font="bold 32px Arial",s.ctx.textAlign="center",s.ctx.fillText("Choose Difficulty Level",this.canvas.width/2,80),s.ctx.fillStyle="#7F8C8D",s.ctx.font="italic 16px Arial",s.ctx.fillText("Select how challenging your maze adventure should be",this.canvas.width/2,110),this.difficultyButtons=[],t.forEach((l,r)=>{const h=a+r*210,f=c;s.ctx.fillStyle=l.color,s.ctx.shadowColor="rgba(0, 0, 0, 0.2)",s.ctx.shadowBlur=8,s.ctx.shadowOffsetY=4,s.ctx.fillRect(h,f,180,120),s.ctx.shadowColor="transparent",s.ctx.strokeStyle="#2C3E50",s.ctx.lineWidth=3,s.ctx.strokeRect(h,f,180,120),s.ctx.fillStyle="#FFFFFF",s.ctx.font="bold 40px Arial",s.ctx.textAlign="center",s.ctx.textBaseline="middle",s.ctx.fillText(l.emoji,h+180/2,f+35),s.ctx.fillStyle="#2C3E50",s.ctx.font="bold 18px Arial",s.ctx.textAlign="center",s.ctx.textBaseline="middle",s.ctx.fillText(l.label,h+180/2,f+70),s.ctx.fillStyle="#2C3E50",s.ctx.font="12px Arial",s.ctx.textAlign="center",s.ctx.textBaseline="middle",this.wrapText(l.description,170).forEach((u,y)=>{s.ctx.fillText(u,h+180/2,f+90+y*12)}),this.difficultyButtons.push({x:h,y:f,width:180,height:120,difficulty:l.id})}),this.canvas.onclick=l=>{if(d.getState()!==v.DIFFICULTY)return;const r=this.canvas.getBoundingClientRect(),h=l.clientX-r.left,f=l.clientY-r.top;if(this.difficultyButtons){for(const g of this.difficultyButtons)if(h>=g.x&&h<=g.x+g.width&&f>=g.y&&f<=g.y+g.height){this.selectDifficulty(g.difficulty);break}}},this.canvas.addEventListener("touchstart",l=>{if(d.getState()!==v.DIFFICULTY)return;const r=this.canvas.getBoundingClientRect(),h=l.touches[0],f=h.clientX-r.left,g=h.clientY-r.top;if(this.difficultyButtons){for(const u of this.difficultyButtons)if(f>=u.x&&f<=u.x+u.width&&g>=u.y&&g<=u.y+u.height){l.preventDefault(),this.selectDifficulty(u.difficulty);break}}},!1)}wrapText(t,e){const i=t.split(" "),n=[];let o="";for(const a of i){const c=o+(o?" ":"")+a;s.ctx.measureText(c).width>e&&o?(n.push(o),o=a):o=c}return o&&n.push(o),n}async selectDifficulty(t){console.log(`üéØ Selected difficulty: ${t}`);let e=null;if(t==="easy"?e=M.EASY:t==="medium"?e=M.MEDIUM:t==="hard"&&(e=M.HARD),!e){console.error(`Invalid difficulty: ${t}`);return}d.selectDifficulty(t),d.setState(v.PLAYING),d.startSession();let i=T.generate(e.width,e.height),n=0;for(;!T.isValidMaze(i.grid,i.start,i.goal)&&n<3;)console.log(`Maze validation failed (attempt ${n+1}/3), regenerating...`),i=T.generate(e.width,e.height),n++;if(!T.isValidMaze(i.grid,i.start,i.goal)){console.error("Failed to generate valid maze after 3 attempts"),await this.showAnimalSelection();return}d.setMaze(i),d.setPlayerPosition(i.start),setTimeout(()=>{this.startGameplay()},500)}async selectAnimal(t){if(console.log(`‚ú® Selected: ${t}`),!S.isValidAnimal(t)){console.error(`Invalid animal: ${t}`);return}this.selectedAnimalForDisplay=t,this.isGeneratingMaze=!0,s.clear(),s.renderAnimalSelection(S.getAllAnimals()),await this.drawAnimalButtons();const e=async()=>{this.isGeneratingMaze&&(s.clear(),s.renderAnimalSelection(S.getAllAnimals()),await this.drawAnimalButtons(),requestAnimationFrame(e))};e(),d.selectAnimal(t),setTimeout(()=>{this.isGeneratingMaze=!1,this.selectedAnimalForDisplay=null,this.showDifficultySelection()},500)}async startGameplay(){console.log("Starting gameplay..."),this.isGeneratingMaze=!1,this.selectedAnimalForDisplay=null,this.difficultyButtons=[];const t=d.getSelectedAnimal();if(t){await s.loadAnimalImage(t);const e=S.getFoodForAnimal(t);e&&await s.loadFoodImage(e)}E.audio&&E.play(),R.bind(this.canvas,e=>this.handleMovement(e),e=>this.handleMovementEnd(e)),this.render(),this.gameLoop()}gameLoop(){this.render(),this.animationFrameId=requestAnimationFrame(()=>this.gameLoop())}handleMovement(t){const e=d.getMaze();if(!e||!t.current)return;const i=this.canvas.getBoundingClientRect(),n=this.canvas.width/i.width,o=this.canvas.height/i.height,a=(t.current.x-i.left)*n,c=(t.current.y-i.top)*o,l=s.currentCellSize||z.CELL_SIZE,r=s.mazeOffsetX||0,h=s.mazeOffsetY||0,f=a-r,g=c-h;let u=Math.floor(f/l),y=Math.floor(g/l);const m=d.getPlayerPosition();let C=0,x=0;if(u!==m.x&&(C=u>m.x?1:-1),y!==m.y&&(x=y>m.y?1:-1),C!==0&&x!==0){const P=Math.abs(u-m.x),I=Math.abs(y-m.y);P>I?x=0:C=0}const A=m.x+C,p=m.y+x;if(A===m.x&&p===m.y){this.render();return}if(!this.isValidMove(e,A,p)){this.render();return}d.setPlayerPosition({x:A,y:p}),d.isAtGoal()&&this.completeGame(),this.render()}isValidMove(t,e,i){return e<0||e>=t.grid[0].length||i<0||i>=t.grid.length?!1:t.grid[i][e].type==="path"}handleMovementEnd(t){this.render()}completeGame(){console.log("üéâ Game completed!"),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),d.setState(v.COMPLETED),d.endSession(),E.pause();const t=d.getSelectedAnimal(),e=d.getSessionDuration();s.renderCompletion(t,e),this.drawReplayButtons()}drawReplayButtons(){const t=this.canvas.width,e=this.canvas.height,i=150,n=50,o=20,a=t/2-i-o/2,c=e-100,l=t/2+o/2,r=e-100;s.ctx.fillStyle="#2ECC71",s.ctx.fillRect(a,c,i,n),s.ctx.fillStyle="#FFFFFF",s.ctx.font="bold 16px Arial",s.ctx.textAlign="center",s.ctx.fillText("Play Again",a+i/2,c+32),s.ctx.fillStyle="#E74C3C",s.ctx.fillRect(l,r,i,n),s.ctx.fillStyle="#FFFFFF",s.ctx.fillText("Quit",l+i/2,r+32),this.replayButtons=[{x:a,y:c,width:i,height:n,action:"play"},{x:l,y:r,width:i,height:n,action:"quit"}];const h=f=>{const g=this.canvas.getBoundingClientRect(),u=f.clientX-g.left,y=f.clientY-g.top;for(const m of this.replayButtons)if(u>=m.x&&u<=m.x+m.width&&y>=m.y&&y<=m.y+m.height){this.canvas.removeEventListener("click",h),m.action==="play"?this.showAnimalSelection():this.quit();break}};this.canvas.onclick=h}quit(){console.log("Quitting game..."),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),s.clear(),s.ctx.fillStyle="#2C3E50",s.ctx.font="32px Arial",s.ctx.textAlign="center",s.ctx.fillText("Thanks for playing!",this.canvas.width/2,this.canvas.height/2)}render(){if(d.getState()===v.PLAYING){const e=d.getMaze(),i=d.getPlayerPosition(),n=d.getSelectedAnimal();if(s.clear(),s.renderMaze(e,z.CELL_SIZE),n){const o=S.getFoodForAnimal(n);o&&s.foodImages[o]&&s.renderFoodIcon(s.foodImages[o],e.goal,z.CELL_SIZE)}n&&s.animalImages[n]&&s.renderAnimalIcon(s.animalImages[n],i,z.CELL_SIZE)}}}document.addEventListener("DOMContentLoaded",()=>{new W().initialize()});
